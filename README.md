# Pirkle — Query CSV and SQLite with PRQL

Pirkle is a command-line tool to query CSV and SQLite files using the [PRQL](https://prql-lang.org/) language.

It loads CSV files into an in-memory SQLite database — allowing you to join them with other tables, apply filters, and export results in table or CSV format.

## Features

- Query CSV files as structured tables
- Join CSV and SQLite files together
- Write expressive queries using PRQL
- Output as a pretty table, CSV, JSON, or logfmt
- Inspect the generated SQL
- Lightweight, fast, and written in Rust


## Installation

### Prebuilt binaries

Prebuilt binaries are available on the [Releases page](https://github.com/dloss/pirkle/releases).

The macOS binaries are code-signed and notarized with Apple, but as a command-line tool, you may still need to:

1. Right-click the executable and choose "Open" the first time you run it

   OR

2. Remove the quarantine attribute via Terminal:
   ```bash
   xattr -d com.apple.quarantine /path/to/pirkle
   ```

### From Source

Or install using [Rust](https://rustup.rs/):

```bash
git clone https://github.com/dloss/pirkle.git
cd pirkle
cargo install --path .
```


## Usage

### Basic Queries

```bash
# Query a CSV file. CSV files are auto-loaded as SQLite tables.
$ pirkle "from employees | filter country == 'USA' | select {name, age}" examples/employees.csv
name            age  
---------------------
John Smith      32   
Robert Johnson  41   
James Brown     39   
```

```bash
# Query a SQLite file (after generating with examples/make_sqlite.sh)
$ pirkle "from employees | select {name, age}" examples/company.sqlite
name     age  
--------------
name     age  
Alice    30   
Bob      45   
Charlie  25   
Diana    35   
Eva      28   
```

```bash
# Filter by department 
$ pirkle "from employees | filter department == 'Engineering' | select {name, age}" examples/employees.csv
name            age  
---------------------
John Smith      32   
Robert Johnson  41   
Ahmed Hassan    29   
Sarah Kim       31   
```


### Show SQL without executing

You can use the `--show-sql` flag to see the SQL that would be generated without executing the query:

```bash
$ pirkle --show-sql "from employees | filter country == 'USA'" examples/employees.csv
SELECT
  *
FROM
  employees
WHERE
  country = 'USA'
-- Generated by PRQL compiler version:0.12.2 (https://prql-lang.org)
```

This also works with PRQL files:

```bash
$ pirkle --show-sql examples/queries/avg_age_by_department.prql examples/employees.csv
SELECT
  department_id,
  AVG(age) AS avg_age
FROM
  employees
GROUP BY
  department_id
-- Generated by PRQL compiler version:0.12.2 (https://prql-lang.org)
```


### Output formats

Default is a readable table format.

To output CSV:

```bash
$ pirkle --format csv "from employees | filter salary > 70000" examples/employees.csv
1,John Smith,Engineering,32,85000,USA
3,Robert Johnson,Engineering,41,92000,USA
5,Ahmed Hassan,Engineering,29,75000,Egypt
8,Sarah Kim,Engineering,31,83000,South Korea
9,James Brown,Sales,39,85000,USA
10,Fatima Al-Farsi,Marketing,36,76000,UAE
```

Other supported formats:

```bash
# JSON Lines format
$ pirkle --format jsonl "from employees | filter country == 'USA'" examples/employees.csv
{"age":"32","country":"USA","department":"Engineering","id":"1","name":"John Smith","salary":"85000"}
{"age":"41","country":"USA","department":"Engineering","id":"3","name":"Robert Johnson","salary":"92000"}
{"age":"39","country":"USA","department":"Sales","id":"9","name":"James Brown","salary":"85000"}
```

```bash
# logfmt format
$ pirkle --format logfmt "from employees | filter country == 'USA'" examples/employees.csv
id="1" name="John Smith" department="Engineering" age="32" salary="85000" country="USA"
id="3" name="Robert Johnson" department="Engineering" age="41" salary="92000" country="USA"
id="9" name="James Brown" department="Sales" age="39" salary="85000" country="USA"
```


### Using PRQL files

You can use prewritten PRQL query files. Some of the example files need to be corrected for the current PRQL version.

Fix for `examples/queries/top_5_paid.prql`:
```prql
from employees
sort -salary
select {name, department, salary}
take 5
```

Fix for `examples/queries/revenue_by_region.prql`:
```prql
from orders
join customers (==customer_id)
group region (
  aggregate {
    total_revenue = sum amount,
    order_count = count this
  }
)
```

After fixing the PRQL files, you can run them directly:

```bash
$ pirkle examples/queries/top_5_paid.prql examples/employees.csv
name                  department    salary
---------------------------------------
Robert Johnson        Engineering   92000
John Smith            Engineering   85000
James Brown           Sales         85000
Sarah Kim             Engineering   83000
Fatima Al-Farsi       Marketing     76000
```


### Multi-line queries

For complex queries, use quotes around the entire query. Note that pipe symbols (`|`) in multi-line format can cause syntax errors:

```bash
# This format works
$ pirkle "from employees
filter salary > 80000
sort -salary
select {name, department, salary}" examples/employees.csv
name             department     salary
-----------------------------------------
Robert Johnson   Engineering    92000
John Smith       Engineering    85000
James Brown      Sales          85000
Sarah Kim        Engineering    83000
```

### Joining tables

To join tables, use the join operation:

```bash
$ pirkle "from orders
join customers (==customer_id)
select {orders.order_id, customers.name, orders.amount}" examples/orders.csv examples/customers.csv
order_id   name            amount
-------------------------------
1          Acme Corp       250
2          Globex Inc      300
3          Acme Corp       150
4          Initech         400
5          Stark Industries 200
```


## Example Data

Included example files:

- `examples/employees.csv`: Employee data with department, salary, and country information
- `examples/departments.csv`: Department names and IDs
- `examples/customers.csv`, `examples/orders.csv`: Customer-order relationship data
- `examples/queries/*.prql`: Sample PRQL queries (Fixed versions provided in this README)


## License

MIT